# ============================================
# 短剧创作Agent评测场景
# ============================================

# --- 基础信息 ---
scenario_name: "短剧创作助手 - 选题到剧本完整流程"
sub_scenario_type: "shortdrama_creation_mvp"
description: "测试Agent的任务规划能力：用户提供题材需求（可选是否指定集数），Agent需自主规划并完成选题生成→角色设计→分集大纲→分集剧本的完整流程。使用文件系统存储输出。"
domain: "creative_content"

# 默认配置
default_config:
  default_episode_count: 20
  description: "当用户未指定集数时，使用默认值20集"

# --- 运行时配置 ---
runtime_config:
  system_time: "2025-07-20T14:00:00Z"
  timezone: "Asia/Shanghai"
  current_date_description: "今天是2025年7月20日，星期日下午14:00"

# --- MCP服务配置 ---
mcp_service_config:
  service_name: "shortdrama_service"
  service_description: "短剧创作服务，提供文件系统操作和HITL交互"
  command: "python"
  args: ["tools/shortdrama_service.py", "${ENV_DIR}"]

  # 场景会使用的MCP工具
  tools_description:
    read_file: "读取文件内容（skill手册、已创建的JSON文档）"
    write_file: "写入单个文件内容（创建选题简报、单个角色卡、单集大纲、单集剧本）"
    write_files: "批量写入多个文件（一次性创建多个角色卡文件、多集大纲、多集剧本），接受文件路径和内容的列表"
    list_directory: "列出目录内容（列出已创建的角色卡文件、大纲文件）"
    create_directory: "创建目录（创建characters/、outlines/、scripts/子目录）"
    bash: "执行shell命令（查看文件系统状态、验证文件结构，内部实现需严格控制权限，只允许在workspace目录下操作，不允许cd到这个之外的地方）"
    request_human_review: "与用户交互的统一工具，支持两种模式：(1)确认模式(type=confirmation)：关键阶段完成后请求用户确认，工具内部硬编码返回accept；(2)询问模式(type=question)：关键信息缺失或需要用户决策时询问，工具内部从sample的hitl_responses配置读取预设答案。参数强约束：stage只能是['信息收集'(question模式-询问缺失信息), '任务进度确认'(question模式-确认是否继续大规模任务), '选题简报'(confirmation模式-完成确认), '角色设计'(confirmation模式-完成确认), '分集大纲'(confirmation模式-完成确认)]，type只能是['confirmation', 'question']；其他参数：summary(确认时的总结或当前进度)、question(询问的问题)、options(可选答案列表)"

# --- 环境配置 ---
environment:
  description: "每个样本的环境包含格式规范文档和题材专属创作手册"
  files:
    - path: "data_pools/output_specifications.yaml"
      description: "输出物格式规范：定义选题简报、角色卡、大纲、剧本的JSON Schema和约束条件"
      required: true
    - path: "data_pools/skills/sweet_romance_skill.md"
      description: "都市甜宠题材创作手册：包含钩子设计、角色原型、情绪曲线等专业指导"
      required_for_genres: ["sweet_romance"]
    - path: "data_pools/skills/revenge_drama_skill.md"
      description: "复仇爽剧题材创作手册：包含钩子设计、角色原型、情绪曲线等专业指导"
      required_for_genres: ["revenge_drama"]
    - path: "data_pools/skills/family_saga_skill.md"
      description: "年代家庭题材创作手册：包含钩子设计、角色原型、情绪曲线等专业指导"
      required_for_genres: ["family_saga"]
    - path: "data_pools/skills/mystery_thriller_skill.md"
      description: "悬疑推理题材创作手册：包含钩子设计、角色原型、情绪曲线等专业指导"
      required_for_genres: ["mystery_thriller"]

  note: "Sample Generator会读取data_pools目录下的所有文件，并添加到每个样本的environment字段中。Agent通过read_file工具访问这些文件。"

# --- 实体定义（输入变量）---
entities:

  # === 唯一的Entity：题材类型（样本变量维度）===
  genres:
    display_name: "题材类型"
    description: "短剧题材维度，每个题材有专属的skill创作手册。这是样本生成的主要变量。"
    id_field: "genre_type"
    sample_count: 4  # 4个题材：甜宠、复仇、家庭、悬疑

    attributes:
      genre_type:
        type: "enum"
        values: ["sweet_romance", "revenge_drama", "family_saga", "mystery_thriller"]
        description: "题材类型标识"

      genre_name_cn:
        type: "string"
        description: "题材中文名称"
        value_mapping:
          sweet_romance: "都市甜宠"
          revenge_drama: "复仇爽剧"
          family_saga: "年代家庭"
          mystery_thriller: "悬疑推理"

      query_template:
        type: "string"
        description: "用户query中的题材描述"
        value_mapping:
          sweet_romance: "都市甜宠短剧"
          revenge_drama: "女性复仇爽剧"
          family_saga: "年代家庭短剧"
          mystery_thriller: "悬疑推理短剧"

      skill_document_path:
        type: "string"
        description: "该题材的专属创作手册路径（Markdown文件）"
        format: "data_pools/skills/{genre_type}_skill.md"

      hook_core_elements:
        type: "array"
        description: "该题材的钩子核心元素枚举值"
        value_mapping:
          sweet_romance: ["身份反差", "危机", "目标"]
          revenge_drama: ["被欺辱", "黑化", "打脸"]
          family_saga: ["时代冲突", "家庭牺牲", "代际传承"]
          mystery_thriller: ["谜团抛出", "信息差冲击", "反转预告"]

      emotional_tone:
        type: "string"
        description: "情绪基调"
        value_mapping:
          sweet_romance: "轻松愉悦、小虐怡情"
          revenge_drama: "压抑→爽快的情绪释放"
          family_saga: "现实沉重但温暖收尾"
          mystery_thriller: "紧张悬疑、层层揭秘"

      target_audience_default:
        type: "string"
        description: "默认目标受众"
        value_mapping:
          sweet_romance: "18-34岁女性"
          revenge_drama: "18-34岁女性"
          family_saga: "25-49岁家庭受众"
          mystery_thriller: "20-39岁都市观众"

      min_antagonist_count:
        type: "integer"
        description: "最少反派角色数量"
        value_mapping:
          sweet_romance: 1
          revenge_drama: 2
          family_saga: 1
          mystery_thriller: 1

# --- 输出物规范（Agent创建的文件）---
output_specifications:

  # === 输出1：选题简报文件 ===
  topic_brief:
    display_name: "选题简报"
    description: "阶段1的输出物：包含题材、受众、平台、十秒钩子的JSON文件"
    file_path: "workspace/topic_brief.json"
    file_format: "json"
    created_by_rule: "rule_topic_generation"

    json_schema:
      type: "object"
      required_fields:
        - genre_type
        - target_audience
        - platform
        - value_proposition
        - hooks

      properties:
        genre_type:
          type: "string"
          description: "题材类型"

        target_audience:
          type: "string"
          description: "目标受众"
          examples: ["18-34岁女性", "25-49岁家庭受众"]

        platform:
          type: "string"
          enum: ["miniapp", "app", "tv"]
          description: "投放平台"

        value_proposition:
          type: "string"
          description: "价值主张（核心卖点）"
          examples: ["高强度情绪推进+密集反转+强CP化学反应"]

        hooks:
          type: "array"
          min_items: 3
          description: "十秒钩子列表"
          items:
            type: "object"
            required: ["hook_text", "core_element", "length"]
            properties:
              hook_text:
                type: "string"
                min_length: 15
                max_length: 50
                description: "钩子文本"
              core_element:
                type: "string"
                description: "核心元素（具体枚举值见对应题材的skill手册）"
              length:
                type: "integer"
                description: "字数统计"

    # Rule Gate 1验证标准
    validation_rules:
      - name: "file_exists"
        description: "文件必须存在"
        check: "file_exists(workspace/topic_brief.json)"

      - name: "hook_count_valid"
        description: "钩子数量≥3"
        check: "len(hooks) >= 3"

      - name: "hook_length_valid"
        description: "每条钩子字数在15-50之间"
        check: "all(15 <= hook['length'] <= 50 for hook in hooks)"

      - name: "hook_element_valid"
        description: "每条钩子包含核心元素"
        check: "hook['core_element'] 在该题材的合法枚举值内（具体值见entities.genres.hook_core_elements）"

  # === 输出2：角色卡文件（多个）===
  character_cards:
    display_name: "角色卡"
    description: "阶段2的输出物：每个角色一个JSON文件"
    file_path_pattern: "workspace/characters/{character_id}.json"
    file_format: "json"
    created_by_rule: "rule_character_design"
    min_file_count: 4  # 至少4个角色

    json_schema:
      type: "object"
      required_fields:
        - character_name
        - identity
        - gap
        - desire
        - secret
        - motivation
        - contrast
        - catchphrase
        - role_type

      properties:
        character_name:
          type: "string"
          description: "角色姓名"

        identity:
          type: "string"
          description: "身份/职业"
          examples: ["跨国集团总裁", "助理", "闺蜜"]

        gap:
          type: "string"
          description: "人物缺口"
          examples: ["情感表达障碍", "信任危机", "自我认同危机"]

        desire:
          type: "string"
          description: "表层欲望"
          examples: ["事业成功", "爱情美满", "证明自己"]

        secret:
          type: "string"
          description: "隐藏秘密"
          examples: ["隐藏真实身份", "家族秘密", "往事创伤"]

        motivation:
          type: "string"
          description: "深层动机"
          examples: ["保护家族企业", "寻找失散亲人", "复仇"]

        contrast:
          type: "string"
          description: "人物反差"
          examples: ["外表高冷但内心宠溺", "看似柔弱实则坚强"]

        catchphrase:
          type: "string"
          description: "口头禅"
          examples: ["你敢！", "有我在", "好的呀"]

        role_type:
          type: "string"
          enum: ["protagonist", "supporting", "antagonist"]
          description: "角色类型"

    # Rule Gate 2验证标准
    validation_rules:
      - name: "character_count_valid"
        description: "角色数量≥4"
        check: "count_files(workspace/characters/*.json) >= 4"

      - name: "fields_complete"
        description: "每个角色的必需字段完整"
        check: "all required fields are filled in each file"

      - name: "hidden_motivation_count"
        description: "至少2个角色有隐藏动机"
        check: "至少2个角色的motivation属于隐藏类型（如复仇、保护、寻找）"
        implementation_note: "需要LLM Judge或关键词匹配判断motivation是否隐藏"

      - name: "protagonist_has_gap"
        description: "主角有明确的缺口/成长目标"
        check: "role_type=='protagonist'的角色，gap字段有明确内容"

  # === 输出3：分集大纲文件（数量动态）===
  episode_outlines:
    display_name: "分集大纲"
    description: "阶段4的输出物：每集一个JSON文件"
    file_path_pattern: "workspace/outlines/episode_{episode_number}.json"
    file_format: "json"
    created_by_rule: "rule_outline_generation"
    expected_file_count: "dynamic"  # 根据用户指定或默认值确定

    json_schema:
      type: "object"
      required_fields:
        - episode_number
        - hook
        - conflict
        - twist
        - emotional_peak
        - scenes
        - characters_involved

      properties:
        episode_number:
          type: "integer"
          minimum: 1
          maximum: 3
          description: "集数编号"

        hook:
          type: "string"
          description: "开场10秒钩子"
          min_length: 10

        conflict:
          type: "string"
          description: "核心冲突"
          min_length: 10

        twist:
          type: "string"
          description: "反转点或信息差"
          min_length: 10

        emotional_peak:
          type: "string"
          description: "情绪峰值"
          min_length: 10

        scenes:
          type: "array"
          items:
            type: "string"
          max_items: 3
          description: "场景列表（最多3个）"

        characters_involved:
          type: "array"
          items:
            type: "string"
          description: "出现的角色名称列表"

    # Rule Gate 4验证标准
    validation_rules:
      - name: "episode_count_valid"
        description: "创建的大纲集数符合要求"
        check: "count_files(workspace/outlines/*.json) == expected_episode_count"
        dynamic: true
        logic: |
          expected_episode_count = 用户query中指定的集数 OR default_episode_count(3)
          实际文件数 == expected_episode_count

      - name: "structure_complete"
        description: "每集都有Hook、冲突、反转、情绪峰值"
        check: "all required fields are non-empty in each file"

      - name: "scene_count_valid"
        description: "每集场景数≤3"
        check: "len(scenes) <= 3 in each file"

      - name: "characters_consistency"
        description: "大纲中的角色必须在角色卡中存在"
        check: "all names in characters_involved exist in character_cards files"
        cross_reference: "character_cards"

  # === 输出4：分集剧本文件（数量动态）===
  episode_scripts:
    display_name: "分集剧本"
    description: "阶段5的输出物：每集一个剧本文件，包含具体的场景、对话和动作"
    file_path_pattern: "workspace/scripts/episode_{episode_number}_script.json"
    file_format: "json"
    created_by_rule: "rule_script_writing"
    expected_file_count: "dynamic"  # 根据用户指定或默认值确定，与大纲数量一致

    json_schema:
      type: "object"
      required_fields:
        - episode_number
        - total_scenes
        - scenes_detail

      properties:
        episode_number:
          type: "integer"
          minimum: 1
          description: "集数编号"

        total_scenes:
          type: "integer"
          minimum: 1
          maximum: 3
          description: "总场景数（与大纲一致，≤3个）"

        scenes_detail:
          type: "array"
          min_items: 1
          max_items: 3
          description: "具体场景剧本列表"
          items:
            type: "object"
            required: ["scene_number", "scene_header", "characters", "content"]
            properties:
              scene_number:
                type: "integer"
                description: "场景编号"

              scene_header:
                type: "object"
                required: ["location", "time", "atmosphere"]
                description: "场景头信息"
                properties:
                  location:
                    type: "string"
                    min_length: 2
                    description: "地点（如：办公室、咖啡厅）"
                  time:
                    type: "string"
                    min_length: 2
                    description: "时间（如：白天、夜晚）"
                  atmosphere:
                    type: "string"
                    min_length: 2
                    description: "氛围（如：紧张、温馨）"

              characters:
                type: "array"
                min_items: 1
                items:
                  type: "string"
                description: "本场景出现的角色名称"

              content:
                type: "array"
                min_items: 1
                description: "场景内容（对话和动作按顺序排列）"
                items:
                  type: "object"
                  required: ["type", "text"]
                  properties:
                    type:
                      type: "string"
                      enum: ["dialogue", "action", "emotion"]
                      description: "内容类型：dialogue对话/action动作描述/emotion情绪描述"
                    character:
                      type: "string"
                      description: "说话人/动作执行者（dialogue和action类型时必需）"
                    text:
                      type: "string"
                      min_length: 5
                      description: "具体内容（台词/动作描述/情绪描述）"

    # Rule Gate 5验证标准
    validation_rules:
      - name: "script_count_valid"
        description: "创建的剧本集数符合要求"
        check: "count_files(workspace/scripts/*.json) == expected_episode_count"
        dynamic: true
        logic: |
          expected_episode_count = 用户query中指定的集数 OR default_episode_count(3)
          实际文件数 == expected_episode_count

      - name: "script_matches_outline_count"
        description: "剧本集数与大纲集数一致"
        check: "count(scripts) == count(outlines)"
        cross_reference: "episode_outlines"

      - name: "scene_count_matches_outline"
        description: "每集剧本的场景数与对应大纲一致"
        check: "script.total_scenes == len(outline.scenes) for each episode"
        cross_reference: "episode_outlines"

      - name: "dialogue_or_action_exists"
        description: "每个场景至少有对话或动作"
        check: "len(scene['content']) > 0 for all scenes"

      - name: "major_characters_in_script_exist"
        description: "剧本中主要角色（有明确姓名）必须在角色卡中存在"
        check: "all named characters in script exist in character_cards (exclude generic roles like '宾客们', '观众', '评委', '董事会成员')"
        cross_reference: "character_cards"
        note: "允许使用通用群众/配角描述（如'宾客们''观众''路人'等），这些不需要角色卡"

      - name: "scene_header_complete"
        description: "每个场景有完整的头信息"
        check: "scene_header包含location/time/atmosphere且非空"

      - name: "content_type_valid"
        description: "场景内容类型合法"
        check: "all content[].type in ['dialogue', 'action', 'emotion']"

# --- 业务规则（Agent执行时必须遵循的逻辑约束）---
business_rules:
  description: "Agent执行时必须遵循的通用业务逻辑（详细格式规范在data_pools/output_specifications.yaml）"

  # 输出物格式规范
  output_format_reference:
    description: "所有输出文件的格式规范"
    rule: |
      - 查阅data_pools/output_specifications.yaml获取详细的格式规范
      - 该文档定义了每个输出文件的JSON Schema、数量约束、值约束、一致性约束
      - 所有约束都与核心能力测试对应，必须严格遵循

  # 集数确定逻辑
  episode_count_logic:
    description: "确定创建多少集大纲和剧本的逻辑"
    rule: |
      - 必须完成用户指定的所有集数
      - 如果用户未指定集数，则使用默认值3集
      - 大纲文件数和剧本文件数必须与确定的集数一致

  # 题材手册查阅
  skill_manual_reference:
    description: "每个题材都有专属的创作手册，必须先查阅再创作"
    rule: |
      - 根据题材类型读取对应的skill手册：data_pools/skills/{genre_type}_skill.md
      - 手册包含该题材的钩子设计要点、角色原型库、分集大纲创作要点
      - 创作内容必须符合该题材的特色（如甜宠的甜蜜互动、复仇的爽快打脸）

  # 关键节点用户确认
  checkpoint_confirmation:
    description: "关键阶段完成后必须请求用户确认"
    rule: |
      交互方式优先级：
      - 优先通过Human In The Loop性质的工具与用户进行交互
      - 仅当工具无法支持所需的交互类型时，才在对话回复中直接询问用户

      必须在以下节点主动请求用户确认，确保创作方向符合预期：
      1. 选题简报完成后 - 确认题材定位、价值主张、十秒钩子
      2. 角色卡全部完成后 - 确认角色设定是否符合题材特点
      3. 分集大纲全部完成后 - 确认故事框架和情节节奏

  # 角色定义约定
  character_definition:
    description: "角色卡创建规则"
    rule: |
      - 角色卡只为有明确姓名的主要角色创建
      - 配角/群众（如"宾客们""观众""评委"）可直接在剧本中使用，无需角色卡
      - 剧本中所有有姓名的角色必须在角色卡中存在

# --- 需求模板（用于样本生成）---
user_need_templates:

  # === 模板1：指定集数 ===
  - need_template_id: "SD_WITH_EPISODE_COUNT"
    description: "用户明确指定集数（标准短剧规模）"
    test_type: "positive"

    # 用户Query（包含集数要求）
    user_need_description: |
      我想做一个{{episode_count}}集的{{query_template}}。

    # 参数（标准短剧集数）
    parameters:
      episode_count: [30, 50]

    # 期望结果（与用户指定一致）
    expected_outcome:
      topic_brief_created: true
      character_count: ">=4"
      outline_count: "{{episode_count}}"  # 动态
      script_count: "{{episode_count}}"   # 动态

    # 具体的检查清单（与episode_count绑定）
    check_list:
      # === 选题简报检查 ===
      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "_exists"
          expected_value: true
        description: "选题简报文件存在"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks"
          expected_value: {"array_min_length": 3}
        description: "钩子数量≥3"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks[*].length"
          expected_value: {"min": 15, "max": 50}
        description: "每个钩子字数15-50"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks[*].core_element"
          expected_value: {"enum": "{{hook_core_elements}}"}
        description: "每个钩子的核心元素合法"

      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "选题简报"}
        description: "选题简报完成后请求用户确认"

      # === 角色卡检查 ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/characters/*.json"}
          min_count: 4
        description: "角色卡数量≥4"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/characters/*.json"
          required_fields: ["character_name", "identity", "gap", "desire", "secret", "motivation", "contrast", "catchphrase", "role_type"]
        description: "角色卡字段完整"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/characters/*.json"
          attribute_key: "role_type"
          expected_value: {"enum": ["protagonist", "supporting", "antagonist"]}
        description: "角色类型枚举值合法"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/characters/*.json"
          attribute_key: "role_type"
          expected_value: {"contains_value": "antagonist", "min_count": "{{min_antagonist_count}}"}
        description: "反派角色数量符合题材要求"

      - check_type: "semantic_check"
        params:
          target_type: "file_field"
          file_pattern: "workspace/characters/*.json"
          field_path: "motivation"
          expected_keywords: ["复仇", "保护", "寻找", "赎罪"]
          use_llm_judge: true
          llm_judge_criteria: "至少2个角色的motivation属于隐藏类型（复仇、保护、寻找、赎罪等）"
          min_count: 2
        description: "至少2个角色有隐藏动机"

      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "角色设计"}
        description: "角色卡完成后请求用户确认"

      # === 大纲检查（根据episode_count） ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/outlines/*.json"}
          expected_count: "{{episode_count}}"
        description: "大纲集数符合要求"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/outlines/*.json"
          required_fields: ["episode_number", "hook", "conflict", "twist", "emotional_peak", "scenes", "characters_involved"]
        description: "大纲结构完整"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/outlines/*.json"
          attribute_key: "scenes"
          expected_value: {"array_max_length": 3}
        description: "每集场景数≤3"

      - check_type: "cross_file_consistency"
        params:
          source_files: "workspace/outlines/*.json"
          source_field: "characters_involved"
          reference_files: "workspace/characters/*.json"
          reference_field: "character_name"
        description: "大纲中角色名称与角色卡一致"

      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "分集大纲"}
        description: "大纲完成后请求用户确认"

      # === 剧本检查（根据episode_count） ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/scripts/*.json"}
          expected_count: "{{episode_count}}"
        description: "剧本集数符合要求"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/scripts/*.json"
          required_fields: ["episode_number", "total_scenes", "scenes_detail"]
        description: "剧本结构完整"

      - check_type: "cross_file_consistency"
        params:
          match_type: "count"
          dir1: "workspace/scripts/"
          dir2: "workspace/outlines/"
        description: "剧本集数与大纲集数一致"

      - check_type: "cross_file_consistency"
        params:
          match_type: "field_value"
          file1_pattern: "workspace/scripts/episode_{N}_script.json"
          file1_field: "total_scenes"
          file2_pattern: "workspace/outlines/episode_{N}.json"
          file2_field: "scenes"
          operation: "count"
        description: "每集剧本场景数与大纲一致"

      - check_type: "cross_file_consistency"
        params:
          source_files: "workspace/characters/*.json"
          source_field: "character_name"
          reference_files: "workspace/scripts/*.json"
          reference_field: "scenes_detail[*].characters"
        description: "角色卡中的角色在剧本中使用"

  # === 模板2：默认集数 ===
  - need_template_id: "SD_DEFAULT_EPISODE"
    description: "用户未指定集数，使用默认3集"
    test_type: "positive"

    # 用户Query（不提集数）
    user_need_description: |
      我想做一个{{query_template}}。

    # 期望结果（使用默认值）
    expected_outcome:
      topic_brief_created: true
      character_count: ">=4"
      outline_count: 3  # 默认值（与System Prompt规则一致）
      script_count: 3   # 默认值（与System Prompt规则一致）

    # 具体的检查清单（固定3集）
    check_list:
      # === 选题简报检查 ===
      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "_exists"
          expected_value: true
        description: "选题简报文件存在"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks"
          expected_value: {"array_min_length": 3}
        description: "钩子数量≥3"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks[*].core_element"
          expected_value: {"enum": "{{hook_core_elements}}"}
        description: "每个钩子的核心元素合法"

      # === 角色卡检查 ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/characters/*.json"}
          min_count: 4
        description: "角色卡数量≥4"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/characters/*.json"
          required_fields: ["character_name", "identity", "gap", "desire", "secret", "motivation", "contrast", "catchphrase", "role_type"]
        description: "角色卡字段完整"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/characters/*.json"
          attribute_key: "role_type"
          expected_value: {"enum": ["protagonist", "supporting", "antagonist"]}
        description: "角色类型枚举值合法"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/characters/*.json"
          attribute_key: "role_type"
          expected_value: {"contains_value": "antagonist", "min_count": "{{min_antagonist_count}}"}
        description: "反派角色数量符合题材要求"

      # === 大纲检查（默认3集） ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/outlines/*.json"}
          expected_count: 3
        description: "大纲集数为3集"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/outlines/*.json"
          required_fields: ["episode_number", "hook", "conflict", "twist", "emotional_peak", "scenes", "characters_involved"]
        description: "大纲结构完整"

      - check_type: "cross_file_consistency"
        params:
          source_files: "workspace/outlines/*.json"
          source_field: "characters_involved"
          reference_files: "workspace/characters/*.json"
          reference_field: "character_name"
        description: "大纲中角色名称与角色卡一致"

      # === 剧本检查（默认3集） ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/scripts/*.json"}
          expected_count: 3
        description: "剧本集数为3集"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/scripts/*.json"
          required_fields: ["episode_number", "total_scenes", "scenes_detail"]
        description: "剧本结构完整"

      - check_type: "cross_file_consistency"
        params:
          match_type: "count"
          dir1: "workspace/scripts/"
          dir2: "workspace/outlines/"
        description: "剧本集数与大纲集数一致"

  # === 模板3：不支持的题材类型（负向测试）===
  - need_template_id: "SD_UNSUPPORTED_GENRE"
    description: "用户请求不在支持范围内的题材类型，测试Agent是否正确拒绝"
    test_type: "negative"

    # 用户Query（请求不支持的题材）
    user_need_description: |
      我想做一个科幻穿越短剧。

    # 期望结果（应该拒绝或告知无法提供服务）
    expected_outcome:
      should_reject: true
      no_files_created: true

    # 具体的检查清单
    check_list:
      # === 验证Agent正确识别并拒绝 ===
      - check_type: "semantic_check"
        params:
          target_type: "response"
          expected_keywords: ["手册", "题材", "不支持", "无法", "暂不", "抱歉"]
          use_llm_judge: true
          llm_judge_criteria: "Agent的回复应明确表示无法提供该题材的创作服务，原因是缺少相应的创作手册或该题材不在支持范围内"
        description: "Agent明确拒绝并说明原因"

      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/*.json"}
          max_count: 0
        description: "未创建任何输出文件"

      - check_type: "tool_call_absence"
        params:
          forbidden_tools: ["write_file", "create_directory"]
        description: "未尝试写入文件或创建目录"

  # === 模板4：信息缺失 - 主动收集（测试HITL询问模式）===
  - need_template_id: "SD_MISSING_GENRE_INFO"
    description: "用户未指定题材，测试Agent是否主动询问收集关键信息"
    test_type: "positive"

    # 用户Query（缺少题材信息）
    user_need_description: |
      我想做短剧。

    # HITL预设响应（与genres entity结合，生成4个样本）
    hitl_responses:
      信息收集:
        answer: "{{genre_name_cn}}"  # Sample Generator会替换成：都市甜宠、复仇爽剧、年代家庭、悬疑推理

    # 期望结果（应询问题材并完成创作）
    expected_outcome:
      topic_brief_created: true
      character_count: ">=4"
      outline_count: 3
      script_count: 3

    # 具体的检查清单（验证询问+完成流程+题材特征正确）
    check_list:
      # === 验证Agent主动询问 ===
      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params:
            stage: "信息收集"
            type: "question"
        description: "Agent调用HITL工具询问题材"

      # === 验证输出文件符合题材特征 ===
      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "_exists"
          expected_value: true
        description: "选题简报文件存在"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks[*].core_element"
          expected_value: {"enum": "{{hook_core_elements}}"}
        description: "钩子核心元素符合该题材要求"

      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/characters/*.json"}
          min_count: 4
        description: "角色卡数量≥4"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/characters/*.json"
          attribute_key: "role_type"
          expected_value: {"contains_value": "antagonist", "min_count": "{{min_antagonist_count}}"}
        description: "反派角色数量符合题材要求"

      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/outlines/*.json"}
          expected_count: 20
        description: "大纲集数为20集"

      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/scripts/*.json"}
          expected_count: 20
        description: "剧本集数为20集"

      # === 验证关键节点确认（至少3次：选题、角色、大纲）===
      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"type": "confirmation"}
          min_count: 3
        description: "至少3次关键节点确认"

  # === 模板5：部分任务范围 - 仅选题+角色 ===
  - need_template_id: "SD_PARTIAL_TASK_TOPIC_CHARACTER"
    description: "用户只要求完成选题和角色设计，测试Agent对任务范围的理解"
    test_type: "positive"

    # 用户Query（明确指定范围）
    user_need_description: |
      我想做一个{{query_template}}，请帮我完成选题和角色设计。

    # 期望结果（只完成选题+角色）
    expected_outcome:
      topic_brief_created: true
      character_count: ">=4"
      outline_count: 0
      script_count: 0

    # 具体的检查清单
    check_list:
      # === 验证选题简报 ===
      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "_exists"
          expected_value: true
        description: "选题简报文件存在"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks[*].core_element"
          expected_value: {"enum": "{{hook_core_elements}}"}
        description: "钩子核心元素合法"

      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "选题简报", "type": "confirmation"}
        description: "选题简报完成后请求确认"

      # === 验证角色卡 ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/characters/*.json"}
          min_count: 4
        description: "角色卡数量≥4"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/characters/*.json"
          required_fields: ["character_name", "identity", "gap", "desire", "secret", "motivation", "contrast", "catchphrase", "role_type"]
        description: "角色卡字段完整"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/characters/*.json"
          attribute_key: "role_type"
          expected_value: {"contains_value": "antagonist", "min_count": "{{min_antagonist_count}}"}
        description: "反派角色数量符合题材要求"

      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "角色设计", "type": "confirmation"}
        description: "角色设计完成后请求确认"

      # === 验证未创建额外内容 ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/outlines/*.json"}
          expected_count: 0
        description: "未创建大纲文件"

      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/scripts/*.json"}
          expected_count: 0
        description: "未创建剧本文件"

  # === 模板6：部分任务范围 - 仅选题 ===
  - need_template_id: "SD_PARTIAL_TASK_TOPIC_ONLY"
    description: "用户只要求完成选题，测试Agent对最小任务范围的理解"
    test_type: "positive"

    # 用户Query（明确指定范围）
    user_need_description: |
      我想做一个{{query_template}}，请帮我完成选题。

    # 期望结果（只完成选题）
    expected_outcome:
      topic_brief_created: true
      character_count: 0
      outline_count: 0
      script_count: 0

    # 具体的检查清单
    check_list:
      # === 验证选题简报 ===
      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "_exists"
          expected_value: true
        description: "选题简报文件存在"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks"
          expected_value: {"array_min_length": 3}
        description: "钩子数量≥3"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks[*].core_element"
          expected_value: {"enum": "{{hook_core_elements}}"}
        description: "钩子核心元素合法"

      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "选题简报", "type": "confirmation"}
        description: "选题简报完成后请求确认"

      # === 验证未创建额外内容 ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/characters/*.json"}
          expected_count: 0
        description: "未创建角色卡文件"

      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/outlines/*.json"}
          expected_count: 0
        description: "未创建大纲文件"

      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/scripts/*.json"}
          expected_count: 0
        description: "未创建剧本文件"

  # === 模板7：大集数任务（压力测试）===
  - need_template_id: "SD_LARGE_EPISODE_COUNT"
    description: "用户要求较大集数（30-50集），测试Agent处理大规模任务的能力"
    test_type: "positive"

    # 用户Query（要求大集数）
    user_need_description: |
      我想做一个{{query_template}}，请帮我完成前{{episode_count}}集的创作。

    # 参数（大集数）
    parameters:
      episode_count: [30, 50]

    # 期望结果（完成大规模创作）
    expected_outcome:
      topic_brief_created: true
      character_count: ">=4"
      outline_count: "{{episode_count}}"
      script_count: "{{episode_count}}"

    # 具体的检查清单
    check_list:
      # === 验证选题简报 ===
      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "_exists"
          expected_value: true
        description: "选题简报文件存在"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/topic_brief.json"
          attribute_key: "hooks[*].core_element"
          expected_value: {"enum": "{{hook_core_elements}}"}
        description: "钩子核心元素合法"

      # === 验证角色卡 ===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/characters/*.json"}
          min_count: 4
        description: "角色卡数量≥4"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/characters/*.json"
          attribute_key: "role_type"
          expected_value: {"contains_value": "antagonist", "min_count": "{{min_antagonist_count}}"}
        description: "反派角色数量符合题材要求"

      # === 验证大纲集数（关键：数量正确）===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/outlines/*.json"}
          expected_count: "{{episode_count}}"
        description: "大纲集数符合要求"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/outlines/*.json"
          required_fields: ["episode_number", "hook", "conflict", "twist", "emotional_peak", "scenes", "characters_involved"]
        description: "大纲结构完整"

      - check_type: "entity_attribute_equals"
        params:
          entity_type: "file"
          target_id: "workspace/outlines/*.json"
          attribute_key: "scenes"
          expected_value: {"array_max_length": 3}
        description: "每集场景数≤3"

      - check_type: "cross_file_consistency"
        params:
          source_files: "workspace/outlines/*.json"
          source_field: "characters_involved"
          reference_files: "workspace/characters/*.json"
          reference_field: "character_name"
        description: "大纲中角色名称与角色卡一致"

      # === 验证剧本集数（关键：数量正确）===
      - check_type: "create_operation_verified"
        params:
          entity_type: "file"
          filter_conditions: {"path_pattern": "workspace/scripts/*.json"}
          expected_count: "{{episode_count}}"
        description: "剧本集数符合要求"

      - check_type: "json_schema"
        params:
          file_pattern: "workspace/scripts/*.json"
          required_fields: ["episode_number", "total_scenes", "scenes_detail"]
        description: "剧本结构完整"

      - check_type: "cross_file_consistency"
        params:
          match_type: "count"
          dir1: "workspace/scripts/"
          dir2: "workspace/outlines/"
        description: "剧本集数与大纲集数一致"

      - check_type: "cross_file_consistency"
        params:
          source_files: "workspace/characters/*.json"
          source_field: "character_name"
          reference_files: "workspace/scripts/*.json"
          reference_field: "scenes_detail[*].characters"
        description: "角色卡中的角色在剧本中使用"

      # === 验证关键节点确认 ===
      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "选题简报", "type": "confirmation"}
        description: "选题简报完成后请求确认"

      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "角色设计", "type": "confirmation"}
        description: "角色设计完成后请求确认"

      - check_type: "tool_called_with_params"
        params:
          tool_name: "request_human_review"
          expected_params: {"stage": "分集大纲", "type": "confirmation"}
        description: "大纲完成后请求确认"

# --- Checker配置 ---
checker_config:
  description: "基于独立脚本模式的检查器，验证Agent创建的文件是否符合业务规则"
  checker_file: "checkers/checker.py"

  # 数据来源
  data_sources:
    final_state: "文件系统快照（workspace/目录下Agent创建的所有JSON文件）"
    result_data: "评测结果数据"

  # 支持的check_type（优先使用标准类型）
  supported_check_types:
    # === 标准check_type（来自框架） ===
    - check_type: "entity_attribute_equals"
      description: "验证字段值是否符合skill规则（业务规则验证）"
      适用场景: "验证数值范围、数组长度、枚举值、字符串长度等value constraints"
      职责: "检查具体的值约束，如hooks数量≥3、字数15-50、role_type枚举值"
      params_example:
        entity_type: "file"
        target_id: "workspace/topic_brief.json"
        attribute_key: "hooks[*].length"
        expected_value: {"min": 15, "max": 50}

    - check_type: "create_operation_verified"
      description: "验证文件创建数量"
      适用场景: "验证创建了指定数量的文件entity"
      params_example:
        entity_type: "file"
        filter_conditions: {"path_pattern": "workspace/characters/*.json"}
        min_count: 4

    - check_type: "semantic_check"
      description: "语义验证（支持LLM Judge）"
      适用场景: "验证Agent回复文本的语义 OR 文件字段内容的语义质量"
      职责: "质量约束检查，如隐藏动机判断、主角缺口质量评估、进展反馈验证"
      params_example:
        # 验证文件字段语义
        target_type: "file_field"
        file_pattern: "workspace/characters/*.json"
        field_path: "motivation"
        expected_keywords: ["复仇", "保护", "寻找", "赎罪"]
        use_llm_judge: true
        llm_judge_criteria: "至少2个角色的motivation属于隐藏类型"

    - check_type: "tool_called_with_params"
      description: "验证工具调用（工具名称和参数）"
      适用场景: "验证Agent是否在规定时机调用了特定工具，如关键节点确认"
      职责: "过程验证，检查工具调用行为是否符合业务流程要求"
      params_example:
        tool_name: "request_human_review"
        expected_params: {"stage": "选题简报"}
        note: "expected_params可以只包含必需验证的参数，其他参数使用null通配"

    # === 场景专用check_type（标准类型无法满足时） ===
    - check_type: "json_schema"
      description: "纯结构和字段存在性验证（format constraints）"
      职责: "只检查必需字段是否存在、类型是否正确，不检查具体值"
      设计原因: "批量验证多个文件的schema，标准类型需要为每个文件写多个check_item"
      params_example:
        file_pattern: "workspace/characters/*.json"
        required_fields: ["character_name", "identity", "gap", "desire", "secret", "motivation", "contrast", "catchphrase", "role_type"]

    - check_type: "cross_file_consistency"
      description: "跨文件引用一致性检查（consistency constraints）"
      设计原因: "需要同时读取多个文件并比对字段，标准check_type难以表达"
      params_example:
        source_files: "workspace/outlines/*.json"
        source_field: "characters_involved"
        reference_files: "workspace/characters/*.json"
        reference_field: "character_name"

  # 检查结果格式
  result_format:
    单项结果: "{检查结论: 合格/不合格/跳过, 原因: string, 详情: string}"
    总体结果: "overall_result: Success/Failure/Error"

# --- 元数据 ---
metadata:
  version: "1.0"
  created_at: "2025-01-10"
  author: "scenario_designer"
  complexity_level: "medium"
  estimated_turns: "5-10"

  design_patterns_used:
    - "复杂业务规则"  # Rule Gate验证
    - "信息洋葱"      # 需查询skill→创建选题→创建角色→创建大纲
    - "任务规划测试"  # Query不列步骤，让Agent自己规划

  core_capabilities_tested:
    - "任务规划与工具组合"  # 自主规划阶段1→2→4流程
    - "多源信息融合"        # 整合skill手册、前序输出
    - "Tool Use"            # 正确调用filesystem工具
    - "Prompt遵循"          # 遵守Rule Gate约束
    - "复杂上下文理解"      # 理解流程依赖关系

# --- 生成选项 ---
generation_options:
  sample_count_per_template: 2
  include_edge_cases: true
  generate_negative_samples: true
  auto_consistency_check: true
